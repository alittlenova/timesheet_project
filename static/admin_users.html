<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>管理员用户管理面板</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    table, th, td { border: 1px solid #ddd; border-collapse: collapse; }
    th, td { padding: 8px; text-align: center; }
    input, select, button { padding: 6px; margin: 4px; }
    .controls { margin: 16px auto; width: 90%; }
    .row-actions { display: flex; gap: 6px; justify-content: center; }
    .toolbar { display:flex; gap:10px; align-items:center; justify-content:space-between; width:90%; margin: 0 auto 8px; }
    .muted { color:#666; font-size: 12px; }
  </style>
</head>
<body>
  <h2 style="text-align:center;">管理员用户管理面板</h2>

  <div class="toolbar">
    <div>
      <label>API 地址：
        <input id="apiBase" value="http://localhost:8000" style="width:280px" />
      </label>
      <label>Admin Token：
        <input id="token" placeholder="eyJhbGciOi..." style="width:420px" />
      </label>
      <button onclick="authenticate()">连接 / 校验权限</button>
    </div>
    <div>
      <input id="q" placeholder="搜索姓名/手机号/ID" oninput="renderTable()" />
      <button onclick="fetchUsers()">刷新</button>
    </div>
  </div>

  <div class="controls">
    <h3>添加新用户</h3>
    <label>姓名: <input id="name" /></label>
    <label>手机号: <input id="mobile" /></label>
    <label>密码（明文）: <input id="password" type="password" /></label>
    <label>角色:
      <select id="role">
        <option value="employee">employee</option>
        <option value="manager">manager</option>
        <option value="admin">admin</option>
      </select>
    </label>
    <label>部门（仅用于新建，之后请到部门管理页调整）:
      <select id="department_select_add">
        <option value="">（无）</option>
      </select>
    </label>
    <button onclick="addUser()">添加</button>
    <span class="muted">* 手机号唯一。如重复，后端会报错。* 新建后自动设为 approved。</span>
  </div>

  <table id="users-table" style="width:90%; margin:auto;">
    <thead>
      <tr>
        <th style="width:60px;">ID</th>
        <th>姓名</th>
        <th>手机号</th>
        <th>邮箱</th>
        <th>角色</th>
        <th style="width:220px;">操作</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    // ====== 状态 ======
    let state = {
      apiBase: 'http://localhost:8000',
      token: '',
      me: null,          // /auth/me
      users: [],
      departments: [],   // [{id,name}] 仅用于“新增用户”下拉
    };

    // 恢复本地配置
    (function init() {
      const url = new URL(location.href);
      const qsApi = url.searchParams.get('apiBase');
      const qsTok = url.searchParams.get('token');

      const savedApi = qsApi || localStorage.getItem('admin_apiBase') || 'http://localhost:8000';
      const savedTok = qsTok || localStorage.getItem('admin_token') || '';

      state.apiBase = savedApi;
      state.token   = savedTok;

      document.getElementById('apiBase').value = savedApi;
      document.getElementById('token').value   = savedTok;

      if (savedApi && savedTok) {
        authenticate();
      } else {
        document.getElementById('token').focus();
      }
    })();

    // ====== 工具函数 ======
    function headersJSON() {
      return {
        'Authorization': `Bearer ${state.token}`,
        'Content-Type': 'application/json'
      };
    }
    async function parseJSONSafe(res) {
      try { return await res.json(); } catch { return null; }
    }
    function getErrorText(resJSON, fallback) {
      if (!resJSON) return fallback;
      if (typeof resJSON.detail === 'string') return resJSON.detail;
      if (Array.isArray(resJSON.detail)) return resJSON.detail.map(d => d.msg || '').join('; ') || fallback;
      return resJSON.message || resJSON.error || fallback;
    }
    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[c]));
    }

    // ====== 权限校验 ======
    async function authenticate() {
      const apiBase = (document.getElementById('apiBase').value || '').trim();
      const token   = (document.getElementById('token').value   || '').trim();

      if (!apiBase || !token) {
        alert('请填写 API 地址与 admin token');
        if (!apiBase) document.getElementById('apiBase').focus();
        else document.getElementById('token').focus();
        return;
      }

      state.apiBase = apiBase;
      state.token   = token;
      localStorage.setItem('admin_apiBase', apiBase);
      localStorage.setItem('admin_token', token);

      try {
        const res = await fetch(`${state.apiBase}/auth/me`, {
          headers: { Authorization: `Bearer ${state.token}` }
        });
        const j = await (async () => { try { return await res.json(); } catch { return null } })();

        if (!res.ok) {
          const msg = j?.detail || j?.message || `校验失败（${res.status}）`;
          throw new Error(msg);
        }

        state.me = j;
        if (j.role !== 'admin') {
          alert('仅 admin 可使用该页面（当前角色：' + j.role + '）');
          return;
        }

        await fetchDepartments(); // 仅用于“新增用户”下拉
        await fetchUsers();
      } catch (err) {
        console.error(err);
        alert('连接/校验失败：' + (err.message || err));
      }
    }

    // ====== 拉取部门（仅用于新增用户的下拉） ======
    async function fetchDepartments() {
      try {
        const res = await fetch(`${state.apiBase}/departments`, {
          headers: { Authorization: `Bearer ${state.token}` }
        });
        if (!res.ok) {
          const j = await parseJSONSafe(res);
          throw new Error(getErrorText(j, `拉取部门失败（${res.status}）`));
        }
        const list = await res.json();
        state.departments = Array.isArray(list) ? list : [];
        renderDeptOptionsForAdd();
      } catch (err) {
        alert('拉取部门失败：' + err.message);
      }
    }

    function renderDeptOptionsForAdd() {
      const sel = document.getElementById('department_select_add');
      sel.innerHTML = `<option value="">（无）</option>` + state.departments
        .map(d => `<option value="${d.id}">${escapeHtml(d.name)}（ID:${d.id}）</option>`)
        .join('');
    }

    // ====== 拉取 & 渲染用户 ======
    async function fetchUsers() {
      try {
        const res = await fetch(`${state.apiBase}/users/`, {
          headers: { 'Authorization': `Bearer ${state.token}` }
        });
        if (!res.ok) {
          const j = await parseJSONSafe(res);
          throw new Error(getErrorText(j, `拉取失败（${res.status}）`));
        }
        const users = await res.json();
        state.users = users;
        renderTable();
      } catch (err) {
        alert('拉取用户失败：' + err.message);
      }
    }

    function renderTable() {
      const q = (document.getElementById('q').value || '').trim().toLowerCase();
      const tbody = document.querySelector('#users-table tbody');
      tbody.innerHTML = '';

      const list = state.users.filter(u => {
        if (!q) return true;
        return (
          String(u.id) === q ||
          (u.name || '').toLowerCase().includes(q) ||
          (u.mobile || '').toLowerCase().includes(q)
        );
      });

      list.forEach(u => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${u.id}</td>
          <td><input value="${escapeHtml(u.name || '')}" data-field="name" /></td>
          <td><input value="${escapeHtml(u.mobile || '')}" data-field="mobile" /></td>
          <td><input value="${escapeHtml(u.email || '')}" data-field="email" /></td>
          <td>
            <select data-field="role">
              <option value="employee" ${u.role==='employee'?'selected':''}>employee</option>
              <option value="manager"  ${u.role==='manager'?'selected':''}>manager</option>
              <option value="admin"    ${u.role==='admin'  ?'selected':''}>admin</option>
            </select>
          </td>
          <td class="row-actions">
            <button data-action="save">保存</button>
            <button data-action="delete" style="color:#c00;border-color:#c00;">删除</button>
          </td>
        `;

        // 行按钮：保存/删除
        tr.addEventListener('click', async (e) => {
          const btn = e.target.closest('button');
          if (!btn) return;
          const action = btn.getAttribute('data-action');
          if (action === 'save') {
            const payload = collectRowPayload(tr);
            try {
              await updateUser(u.id, payload, true);
              await fetchUsers();
            } catch (err) { /* 已在 updateUser 提示 */ }
          } else if (action === 'delete') {
            if (!confirm(`确定要删除用户 #${u.id} 吗？`)) return;
            try {
              await deleteUser(u.id);
              await fetchUsers();
            } catch (err) { /* 已在 deleteUser 提示 */ }
          }
        });

        // 输入变更即保存（仅保存非部门字段）
        tr.querySelectorAll('input,select').forEach(el => {
          el.addEventListener('change', async () => {
            const field = el.getAttribute('data-field');
            const value = el.value;
            try {
              await updateUser(u.id, { [field]: value }, false);
            } catch (err) { /* 已在 updateUser 提示 */ }
          });
        });

        tbody.appendChild(tr);
      });
    }

    function collectRowPayload(tr) {
      const payload = {};
      tr.querySelectorAll('[data-field]').forEach(el => {
        const field = el.getAttribute('data-field');
        payload[field] = el.value;
      });
      return payload;
    }

    // ====== 仅用于新增：把用户加入某部门 ======
    async function assignDepartment(userId, deptId) {
      if (!deptId) return;
      const did = parseInt(deptId, 10);
      if (!Number.isFinite(did)) return;

      const url = `${state.apiBase}/departments/${did}/add_user`;
      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${state.token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ user_id: userId })
      });
      if (!res.ok) {
        const text = await res.text().catch(() => '');
        throw new Error(`加入部门失败（${res.status}）\nURL: ${url}\n${text}`);
      }
    }

    // ====== 新增用户 ======
    function findUserIdByMobile(mobile) {
      const u = (state.users || []).find(x => String(x.mobile || '') === String(mobile || ''));
      return u ? u.id : null;
    }

    async function addUser() {
      const mobile = document.getElementById('mobile').value.trim();

      const body = {
        name: document.getElementById('name').value.trim(),
        mobile,
        password: document.getElementById('password').value,
        role: document.getElementById('role').value,
      };

      try {
        // 1) 创建
        const res = await fetch(`${state.apiBase}/auth/register`, {
          method: 'POST',
          headers: headersJSON(),
          body: JSON.stringify(body)
        });
        const created = await parseJSONSafe(res);
        if (!res.ok) {
          throw new Error(getErrorText(created, `创建失败（${res.status}）`));
        }

        // 2) 获取新ID
        let newId = created && (created.id || created.user_id);
        if (!newId) {
          await fetchUsers();
          newId = findUserIdByMobile(mobile);
        }

        // 3) 立刻批准
        if (newId) {
          const approveRes = await fetch(`${state.apiBase}/users/${newId}/approve`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${state.token}` }
          });
          if (!approveRes.ok) {
            const j = await parseJSONSafe(approveRes);
            throw new Error(getErrorText(j, `已创建，但批准失败（${approveRes.status}）`));
          }
        }

        // 4) 若新增时选了部门 → 加入部门（仅新增时可选）
        const rawDept = document.getElementById('department_select_add').value;
        if (newId && rawDept) {
          await assignDepartment(newId, parseInt(rawDept, 10));
        }

        alert('用户添加成功，已自动设为 approved');
        // 清空输入
        ['name','mobile','password'].forEach(id => document.getElementById(id).value = '');
        document.getElementById('role').value = 'employee';
        document.getElementById('department_select_add').value = '';

        await fetchUsers();
      } catch (err) {
        alert('添加失败：' + err.message);
      }
    }

    // ====== 更新 / 删除（不涉及部门） ======
    async function updateUser(id, patch, silent) {
      try {
        const res = await fetch(`${state.apiBase}/users/${id}`, {
          method: 'PUT',
          headers: headersJSON(),
          body: JSON.stringify(patch)
        });
        if (!res.ok) {
          const j = await parseJSONSafe(res);
          throw new Error(getErrorText(j, `更新失败（${res.status}）`));
        }
        if (!silent) alert('更新成功');
      } catch (err) {
        alert('更新失败：' + err.message);
        throw err;
      }
    }

    async function deleteUser(id) {
      try {
        const res = await fetch(`${state.apiBase}/users/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${state.token}` }
        });
        if (!res.ok) {
          const j = await parseJSONSafe(res);
          throw new Error(getErrorText(j, `删除失败（${res.status}）`));
        }
      } catch (err) {
        alert('删除失败：' + err.message);
        throw err;
      }
    }
  </script>
</body>
</html>
